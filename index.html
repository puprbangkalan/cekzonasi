<!DOCTYPE html>
<html>
<head>
  <title>Zonasi Checker Bangkalan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    /* Styling for the page layout, map, and info panel */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
    }
    #map {
      flex-grow: 1; /* Map takes up available vertical space */
      width: 100%;
      min-height: 300px; /* Minimum height for the map */
    }
    #info {
      padding: 15px;
      background-color: #f8f8f8;
      border-top: 1px solid #eee;
      text-align: center;
    }
    #coordinates {
      font-weight: bold;
      margin-bottom: 10px;
    }
    #checkButton {
      background-color: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }
    #checkButton:hover {
      background-color: #0056b3;
    }
    #checkButton:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    #result {
      margin-top: 15px;
      text-align: left;
      padding: 0 10px;
      white-space: pre-wrap; /* Preserve line breaks */
      word-wrap: break-word; /* Break long words */
      max-height: 200px; /* Limit height of result display */
      overflow-y: auto; /* Add scroll if content overflows */
    }
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-left: 10px;
      display: none; /* Hidden by default */
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="info">
    <div id="coordinates">Klik pada peta untuk mendapatkan koordinat</div>
    <button id="checkButton">Cek Titik</button>
    <div class="loading-spinner" id="loadingSpinner"></div>
    <div id="result"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    var map;
    var marker;
    var currentCoords = null;

    // --- PENTING: GANTI DENGAN URL EDGE FUNCTION ANDA! ---
    // Contoh: https://YOUR_SUPABASE_PROJECT_REF.supabase.co/functions/v1/check-zonasi
    const EDGE_FUNCTION_URL = 'GANTI_DENGAN_URL_EDGE_FUNCTION_ANDA'; // <-- TEMPELKAN URL DI SINI

    document.addEventListener('DOMContentLoaded', function() {
      // Inisialisasi peta Leaflet, fokus di sekitar Bangkalan
      map = L.map('map').setView([-7.0169, 113.3333], 12);

      // Tambahkan Esri World Street Map sebagai basemap layer gratis
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri Korea, Esri (Thailand), NGCC, (c) OpenStreetMap contributors, and the GIS User Community'
      }).addTo(map);

      // Tangani klik pada peta untuk mendapatkan koordinat
      map.on('click', function(e) {
        if (marker) {
          map.removeLayer(marker); // Hapus marker sebelumnya jika ada
        }
        marker = L.marker(e.latlng).addTo(map); // Tambahkan marker baru di lokasi klik
        currentCoords = e.latlng;
        document.getElementById('coordinates').innerText = `Koordinat: ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;
        document.getElementById('result').innerText = ''; // Bersihkan hasil sebelumnya
      });

      // Tangani klik tombol "Cek Titik"
      document.getElementById('checkButton').addEventListener('click', async function() {
        if (currentCoords) {
          // Tampilkan indikator loading dan nonaktifkan tombol
          document.getElementById('result').innerText = 'Memeriksa...';
          document.getElementById('loadingSpinner').style.display = 'inline-block';
          document.getElementById('checkButton').disabled = true;

          try {
            // Lakukan permintaan ke Edge Function
            const response = await fetch(EDGE_FUNCTION_URL, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ lat: currentCoords.lat, lng: currentCoords.lng })
            });

            const data = await response.json(); // Parsing respons JSON

            // Tangani respons dari Edge Function
            if (!response.ok) {
              throw new Error(data.error || 'Terjadi kesalahan saat memeriksa zonasi.');
            }

            if (data.error) {
              document.getElementById('result').innerText = `Error: ${data.error}`;
            } else if (data.message) {
              document.getElementById('result').innerText = data.message;
            } else {
              // Tampilkan KODE dan detail zonasi
              let resultText = `KODE: ${data.KODE}\n\n`;
              if (data.zonasiDetails) {
                resultText += 'Detail Zonasi:\n';
                // Iterasi melalui semua kolom dalam zonasiDetails
                for (const key in data.zonasiDetails) {
                  if (Object.hasOwnProperty.call(data.zonasiDetails, key)) {
                    resultText += `${key}: ${data.zonasiDetails[key]}\n`;
                  }
                }
              }
              document.getElementById('result').innerText = resultText;
            }
          } catch (error) {
            // Tangani kesalahan jaringan atau dari server
            document.getElementById('result').innerText = `Error: ${error.message}`;
            console.error("Fetch error:", error);
          } finally {
            // Sembunyikan spinner dan aktifkan kembali tombol
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('checkButton').disabled = false;
          }
        } else {
          document.getElementById('result').innerText = 'Silakan klik pada peta terlebih dahulu.';
        }
      });
    });
  </script>
</body>
</html>
